name: SonarQube Analysis

on:
  workflow_dispatch:  # permite executar manualmente pelo botão "Run workflow"
  push:
    branches: [ develop, main, feature/*, fix/* ]
  pull_request:
    branches: [ develop, main ]
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ESSENCIAL: Permite que o Sonar analise o histórico completo

      - name: Set up JDK 17 # Ajuste para a versão do seu Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and Scan with Sonar
        env:
          # A URL do SonarCloud é padrão, mas você pode passar a sua aqui
          # Caso esteja usando uma instância self-hosted
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

        run: |
          # O comando limpa, executa os testes (jacoco gera o arquivo .exec) e depois o SonarScanner
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=gustavo1282_wallet-service-api \
            -Dsonar.organization=gustavo1282 \
            -Dsonar.host.url=https://sonarcloud.io